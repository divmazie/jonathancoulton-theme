{% extends "base.twig" %}

{% macro variants_modal(prompt,allow_multiple,id,name,variants) %}
    <div id="product_modal_{{ id }}" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">{{ prompt|default('Please select your preferred option.') }}</h4>
                </div>
                <div class="modal-body">
                    {% set variants_json = [] %}
                    {% for variant in variants %}
                        {% set variants_json = variants_json|merge([{ 'option': variant.title, 'id': variant.id }]) %}
                    {% endfor %}
                    {% for variant in variants %}
                        <button onclick='addToCart({{ id }},"{{ name }}",{{ variant.price|number_format }},{{ variants_json|json_encode() }},{{ variant.id }},{{ allow_multiple }})'>{{ variant.title }}</button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endmacro %}
{% import _self as macros %}

{% block content %}
<div class="container">
    <nav id="nav-store">
        <ul>
            <li class="menu-item">
                <a onclick="store_nav('downloads')">Downloads</a>
            </li>
            <div class="menu_slash">/</div>
            <li>
                <a onclick="store_nav('shirts')">Shirts</a>
            </li>
        </ul>
    </nav>
    <div data-bind="visible: store_view() == 'downloads'">
    {% for album in store.albums %}
        <div class="col-xs-12 col-sm-4">
            <div class="album_square">
                <img src="{{ album.collection.image.src }}" class="album_image" />
            </div>
        </div>
        <div class="col-xs-12 col-sm-8">
            <h3>{{ album.collection.title }}</h3>
            <span class="album_year">{{ album.collection.body_html }}</span>
            {% for track in album.products %}
                <div class="track_row">
                    <span class="track_icon_left">{% if track.metafields.track_number > 0 %}{{ track.metafields.track_number }}{% endif %}</span>
                    <span class="track_icon_left">{% if track.metafields.track_number > 0 %}&#9654;{% endif %}</span>
                    <span class="track_title">{{ track.title }}</span>
                    <span class="track_icon_right">
                        <a data-bind="visible: !in_cart({ product_id: {{ track.id }} })" data-toggle="modal" data-target="#product_modal_{{ track.id }}">cart</a>
                        <span data-bind="visible: in_cart({ product_id: {{ track.id }} })">&#x2713;</span>
                    </span>
                    <span class="track_icon_right">${{ track.variants[0].price|number_format }}</span>
                    <span class="track_icon_right">&#x24D8;</span>
                </div>
                {{ macros.variants_modal('Please select a file format for your download.','false',track.id,track.title,track.variants) }}
            {% endfor %}
        </div>
        <div class="clearfix"></div>
    {% endfor %}
    </div>
    <div data-bind="visible: store_view() == 'shirts'">
        {% for shirt in store.shirts %}
            <div class="col-lg-3">
                <img src="{{ shirt.image.src }}" class="album_image" /><br />
                {{ shirt.title }}<br />
                {{ shirt.body_html }}<br />
                <a data-toggle="modal" data-target="#product_modal_{{ shirt.id }}">cart</a>
            </div>
            {{ macros.variants_modal('Please select your shirt size.','true',shirt.id,shirt.title,shirt.variants) }}
        {% endfor %}
        <div class="clearfix"></div>
    </div>
    <button data-bind="visible: cart().length > 0" data-toggle="modal" data-target="#cart_modal">Show cart</button>
</div>
<div id="cart_modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">SHOPPING CART!</h4>
            </div>
            <div class="modal-body">
                <div data-bind="foreach: cart">
                    <div>
                        Name: <span data-bind="text: product_name"></span>
                        Product: <span data-bind="text: product_id"></span>
                        Variant: <span data-bind="text: variant_id"></span>
                        Price: <span data-bind="text: price"></span>
                        <select data-bind="options: variants, value: variant, optionsText: 'option'"></select>
                        <a data-bind="click: $root.remove_product">Remove</a>
                    </div>
                </div>
                Link: <span data-bind="text: checkout_link"></span>
                <a data-bind="attr: { href: checkout_link }, visible: cart().length > 0">CHECKOUT!</a>
            </div>
        </div>
    </div>
</div>
    <pre>{{ store|print_r }}</pre>

    <script type="application/javascript">
        var shopify_domain = "http://jonathan-coulton.myshopify.com";
        function CartItem(product_id,product_name,price,variants,variant) {
            var self = this;
            self.product_id = product_id;
            self.product_name = product_name;
            self.price = price;
            self.variants = ko.observableArray(variants);
            self.variant = ko.observable(variant);
            self.variant_id = ko.computed(function() {
                return self.variant().id;
            });
            self.quantity = ko.observable(1);
        }
        var ViewModel = function(start_cart) {
            var self = this;
            self.store_view = ko.observable('downloads');
            self.cart = ko.observableArray(start_cart);
            self.remove_product = function(product) {
                self.cart.remove(product);
                self.store_local();
            }
            self.checkout_link = ko.computed(function() {
                var link = shopify_domain + "/cart/";
                var comma = "";
                for (var i=0; i<self.cart().length; i++) {
                    link += comma + self.cart()[i].variant_id() + ":" + self.cart()[i].quantity();
                    comma = ",";
                }
                return link;
            });

            self.in_cart = function(product) {
                for (var i=0; i<self.cart().length; i++) {
                    if (self.cart()[i].product_id == product.product_id) {
                        return true;
                    }
                }
                return false;
            }
            self.store_local = function() {
                if(typeof(Storage) !== "undefined") {
                    sessionStorage.setItem('cart',ko.toJSON(self.cart()));
                }
            }
        };

        var start_cart = [];
        if(typeof(Storage) !== "undefined") {
            //sessionStorage.setItem('cart',[]);
            var stored_cart = JSON.parse(sessionStorage.getItem('cart'));
            for (var i = 0; i < stored_cart.length; i++) {
                start_cart.push(new CartItem(stored_cart[i].product_id,stored_cart[i].product_name,stored_cart[i].price,stored_cart[i].variants,stored_cart[i].variant));
            }
        }
        var myViewModel = new ViewModel(start_cart);
        ko.applyBindings(myViewModel);

        function store_nav(section) {
            myViewModel.store_view(section);
        }

        function addToCart(product_id,product_name,price,variants,variant_id,allow_multiple) {
            var variant = variants[0];
            for (var i = 0; i < variants.length; i++) {
                if (variants[i].id == variant_id) {
                    variant = variants[i];
                }
            }
            var product = new CartItem(product_id,product_name,price,variants,variant);
            if (allow_multiple || !myViewModel.in_cart(product)) {
                myViewModel.cart.push(product);
            }
            $('#product_modal_'+product_id).modal('hide');
            myViewModel.store_local();
        }
    </script>
{% endblock %}