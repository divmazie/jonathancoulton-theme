{% extends "base.twig" %}

{% macro variants_modal(prompt,allow_multiple,id,name,variants) %}
    {% set variants_json = [] %}
    {% for variant in variants %}
        {% set variants_json = variants_json|merge([{ 'option': variant.title, 'id': variant.id }]) %}
    {% endfor %}
    {% if variants|length > 1 %}
        <div id="product_modal_{{ id }}" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">{{ prompt|default('Please select your preferred option.') }}</h4>
                    </div>
                    <div class="modal-body">
                        <div data-bind="visible: store_view() == 'downloads'">
                            <label><input type="checkbox" data-bind="checked: remember_format" /> Make this format my default.</label>
                        </div>
                        {% for variant in variants %}
                            <button onclick='addToCart({{ id }},"{{ name }}",{{ variant.price|number_format }},{{ variants_json|json_encode() }},{{ variant.id }},{{ allow_multiple }})' id="product{{ id }}_{{ variant.title }}">{{ variant.title }}</button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <script>
            function add_{{ id }}_to_cart() {
                addToCart({{ id }},"{{ name }}",{{ variants[0].price|number_format }},{{ variants_json|json_encode() }},{{ variants[0].id }},{{ allow_multiple }});
            }
        </script>
    {% endif %}
{% endmacro %}
{% import _self as macros %}

{% block second_header %}
    <nav id="nav-store">
        <div class="container">
            <ul>
                {% for category in store %}
                    {% if not loop.first %}<div class="menu_slash">/</div>{% endif %}
                    <li class="menu-item" data-bind="css: { 'current-menu-item': store_view() == '{{ category.html_name }}' }">
                        <a onclick="store_nav('{{ category.html_name }}')">{{ category.name }}</a>
                    </li>
                {% endfor %}
                <div class="cart_link" data-toggle="modal" data-target="#cart_modal">
                    <span class="cart_image" data-bind="css: { cart_full: cart().length > 0}, text: pos_cart_number"></span>
                    <span class="cart_text">CART</span>
                </div>
            </ul>
        </div>
    </nav>
{% endblock %}

{% block content %}
<div class="container">
    {% if store|length < 1 %}
        <p>The store is temporarily offline.</p>
    {% endif %}
    {% for category in store %}
        <div data-bind="visible: store_view() == '{{ category.html_name }}'">
            {% if category.shopify_type == 'Music download' %}
                {% for album in category.products %}
                    <div class="col-xs-12 col-sm-4">
                        <div class="album_square">
                            <img src="{{ album.collection.image.src }}" class="album_image" />
                        </div>
                        {% for track in album.products %}
                            {% if track.metafields.track_number == 0 %}
                                <a data-bind="visible: !in_cart({ product_id: {{ track.id }} })" onclick="option_modal({{ track.id }})">
                                    <div class="add_to_cart_box_blue">
                                        Add album to cart
                                        <img src="{{ theme.link }}/images/add_to_cart_white.svg" class="track_icon_img" />
                                    </div>
                                </a>
                                <div data-bind="visible: in_cart({ product_id: {{ track.id }} })" class="add_to_cart_box_blue">
                                    Album in cart
                                    <img src="{{ theme.link }}/images/checked_white.svg" class="track_icon_img" />
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="col-xs-12 col-sm-8">
                        <h3 class="album_title">{{ album.collection.title }}</h3>
                        <span class="album_year">{{ album.collection.body_html }}</span>
                        {% for track in album.products %}
                            <div class="track_row {% if track.metafields.track_number == 0 %}album_row{% endif %}" data-bind="css: { play_row: current_song() == {{ track.id }} }">
                                <span class="track_icon_left">{% if track.metafields.track_number > 0 %}{{ track.metafields.track_number }}{% endif %}</span>
                                <span class="track_icon_left">{% if track.metafields.track_number > 0 %}
                                    <span data-bind="visible: player_ready">
                                        <span data-bind="visible: current_song() != {{ track.id }}">
                                            <a onclick="playSound({{ track.id }})"><img src="{{ theme.link }}/images/play_black.svg" class="track_play_img"></a>
                                        </span>
                                        <span data-bind="visible: current_song() == {{ track.id }}">
                                            <a onclick="stopSound()"><img src="{{ theme.link }}/images/pause_black.svg" class="track_play_img"></a>
                                        </span>
                                    </span>
                                    {% endif %}</span>
                                <span class="track_title">{{ track.title }}</span>
                                <span class="track_icon_right">
                                    <a data-bind="visible: !in_cart({ product_id: {{ track.id }} })" onclick="option_modal({{ track.id }})">
                                        <img src="{{ theme.link }}/images/add_to_cart_blue.svg" class="track_icon_img">
                                    </a>
                                    <span data-bind="visible: in_cart({ product_id: {{ track.id }} })">
                                        <img src="{{ theme.link }}/images/checked_blue.svg" class="track_icon_img">
                                    </span>
                                </span>
                                <span class="track_icon_right">${{ track.variants[0].price|number_format }}</span>
                                <span class="track_icon_right">
                                    <a href="{{ track.metafields.wiki_link }}" class="track_info_icon {% if track.metafields.track_number == 0 %}album_info_icon{% endif %}"></a>
                                </span>
                            </div>
                            {{ macros.variants_modal('Please select a file format for your download.','false',track.id,track.title,track.variants) }}
                        {% endfor %}
                    </div>
                    <div class="clearfix"></div>
                {% endfor %}
            {% else %}
                {% for product in category.products %}
                    <div class="col-lg-3">
                        <div class="album_square">
                            <img src="{{ product.image.src }}" class="album_image" /><br />
                        </div>
                        <a onclick="option_modal('{{ product.id }}')" class="no_underline">
                            <div class="add_to_cart_box_blue" style="margin: 0 0 20px;">
                                <span data-bind="visible: !in_cart({ product_id: {{ product.id }} })">
                                    ${{ product.variants[0].price|number_format }} | Add to cart
                                    <img src="{{ theme.link }}/images/add_to_cart_white.svg" class="track_icon_img" />
                                </span>
                                <span data-bind="visible: in_cart({ product_id: {{ product.id }} })">
                                    ${{ product.variants[0].price|number_format }} | Add another
                                    <img src="{{ theme.link }}/images/checked_white.svg" class="track_icon_img" />
                                </span>
                            </div>
                        </a>
                        <div class="product_title">{{ product.title }}</div>
                        <div class="product_description">{{ product.body_html }}</div>
                    </div>
                    {{ macros.variants_modal('','true',product.id,product.title,product.variants) }}
                {% endfor %}
                <div class="clearfix"></div>
            {% endif %}
        </div>
    {% endfor %}
</div>
<div id="cart_modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">SHOPPING CART!</h4>
            </div>
            <div class="modal-body">
                <div data-bind="foreach: cart">
                    <div class="cart_row">
                        <span data-bind="text: product_name"></span>
                        <span class="cart_icon_right"><a data-bind="click: $root.remove_product">&#x2715;</a></span>
                        <span class="cart_icon_right">$<span data-bind="text: calculated_cost"></span></span>
                        <span class="cart_icon_right"><select data-bind="options: variants, value: variant, optionsText: 'option', visible: variants().length > 1"></select></span>
                        <span class="cart_icon_right"><a data-bind="click: duplicate_item, visible: allow_multiple">Duplicate</a></span>
                        <!--<span class="cart_icon_right"><input type="number" data-bind="value: quantity, visible: allow_multiple" min="0" style="width: 50px;" /></span>
                        Product: <span data-bind="text: product_id"></span>
                        Variant: <span data-bind="text: variant_id"></span>
                        -->
                    </div>
                </div>
                Total: $<span data-bind="text: total_cost"></span><br />
                (Shipping and tax calculated at checkout.)<br /><br />
                <a data-bind="attr: { href: checkout_link }, visible: cart().length > 0">CHECKOUT!</a>
            </div>
        </div>
    </div>
</div>
<div id="cart_confirm_modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Item added to cart!</h4>
            </div>
            <div class="modal-body">
                <span id="cart_confirm_product_name"></span> has been added to your shopping cart!
            </div>
        </div>
    </div>
</div>
    <div id="purchase_confirm_modal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Item added to cart!</h4>
                </div>
                <div class="modal-body">
                    Thank you for your order from jonathancoulton.com!<br />
                    <br />
                    You are awesome.<br />
                    <br />
                    <a onclick="$('#purchase_confirm_modal').modal('hide')"><div class="blue_arrow_left">Back</div></a>
                </div>
            </div>
        </div>
    </div>
    <pre id="debug"></pre>
    <pre>{{ store|print_r }}</pre>

    <script type="application/javascript">
        var shopify_domain = "http://jonathan-coulton.myshopify.com";
        var default_audio_format = "";

        function CartItem(product_id,product_name,price,variants,variant,quantity,allow_multiple) {
            var self = this;
            self.product_id = product_id;
            self.product_name = product_name;
            self.price = price;
            self.quantity = ko.observable(quantity);
            self.calculated_cost = ko.computed(function () {
                return self.price * self.quantity();
            });
            self.variants = ko.observableArray(variants);
            self.variant = ko.observable(variant);
            self.variant_id = ko.computed(function() {
                return self.variant().id;
            });
            self.allow_multiple = allow_multiple;
            self.duplicate_item = function() {
                addToCart(self.product_id,self.product_name,self.price,self.variants(),self.variant_id(),self.allow_multiple);
            }
        }
        var ViewModel = function(start_cart) {
            var self = this;
            self.player_ready = ko.observable(false);
            self.current_song = ko.observable();
            self.store_view = ko.observable('{{ get_vars.store_section|default('downloads') }}');
            self.remember_format = ko.observable(true);
            self.cart = ko.observableArray(start_cart);
            self.remove_product = function(product) {
                self.cart.remove(product);
            }
            self.pos_cart_number = ko.computed(function() {
                if (self.cart().length > 0) {
                    return self.cart().length;
                } else {
                    return "";
                }
            });
            self.total_cost = ko.computed(function() {
                var total = 0;
                for (var i=0; i<self.cart().length; i++) {
                    total += self.cart()[i].calculated_cost();
                }
                return total;
            });
            self.checkout_link = ko.computed(function() {
                var link = shopify_domain + "/cart/";
                var comma = "";
                for (var i=0; i<self.cart().length; i++) {
                    link += comma + self.cart()[i].variant_id() + ":" + self.cart()[i].quantity();
                    comma = ",";
                }
                return link;
            });

            self.in_cart = function(product) {
                for (var i=0; i<self.cart().length; i++) {
                    if (self.cart()[i].product_id == product.product_id) {
                        return true;
                    }
                }
                return false;
            }
            self.store_local = ko.computed(function() {
                if(typeof(Storage) !== "undefined") {
                    sessionStorage.setItem('cart',ko.toJSON(self.cart()));
                }
            });
        };

        var start_cart = [];
        if(typeof(Storage) !== "undefined" && sessionStorage.getItem('cart')) {
            //sessionStorage.setItem('cart',[]);
            //var stored_cart = start_cart;
            $('#debug').html(sessionStorage.getItem('cart'));
            var stored_cart = JSON.parse(sessionStorage.getItem('cart'));
            for (var i = 0; i < stored_cart.length; i++) {
                var variant = find_variant(stored_cart[i].variants,stored_cart[i].variant_id);
                start_cart.push(new CartItem(stored_cart[i].product_id,stored_cart[i].product_name,stored_cart[i].price,stored_cart[i].variants,variant,stored_cart[i].quantity,stored_cart[i].allow_multiple));
            }
        }
        var myViewModel = new ViewModel(start_cart);
        ko.applyBindings(myViewModel);

        function store_nav(section) {
            myViewModel.store_view(section);
        }

        function option_modal(product_id) {
            var product_modal = $('#product_modal_'+product_id);
            var default_button = product_modal.find('#product'+product_id+'_'+default_audio_format);
            if (default_button.size()) {
                default_button.click();
            } else if (product_modal.size()) {
                product_modal.modal('show');
            } else {
                window["add_"+product_id+"_to_cart"](product_id);
            }
        }

        function addToCart(product_id,product_name,price,variants,variant_id,allow_multiple) {
            var variant = find_variant(variants,variant_id);
            if (myViewModel.store_view() == 'downloads' && myViewModel.remember_format()) {
                default_audio_format = variant.option;
            }
            var product = new CartItem(product_id,product_name,price,variants,variant,1,allow_multiple);
            if (allow_multiple || !myViewModel.in_cart(product)) {
                myViewModel.cart.push(product);
            }
            $('#product_modal_'+product_id).modal('hide');
            $('#cart_confirm_product_name').html(product_name);
            $('#cart_confirm_modal').modal('show');
            setTimeout("$('#cart_confirm_modal').modal('hide')",1500);
        }
        function find_variant(variants,variant_id) {
            var variant = variants[0];
            for (var i = 0; i < variants.length; i++) {
                if (variants[i].id == variant_id) {
                    variant = variants[i];
                }
            }
            return variant;
        }

        {% if get_vars.return_from_shopify %}
        window.onload = function() {
            myViewModel.cart([]);
            sessionStorage.setItem('cart',ko.toJSON([]));
            $('#purchase_confirm_modal').modal('show');
        }
        {% endif %}

        var playlist = [
            {% for category in store %}
                {% if category.shopify_type == 'Music download' %}
                    {% for album in category.products %}
                        {% for track in album.products %}
                            {% if track.metafields.music_link %}
                                { id: {{ track.id }}, url: '{{ track.metafields.music_link }}' },
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        ];

        soundManager.setup({
            url: '/path/to/swf-files/',
            flashVersion: 9, // optional: shiny features (default = 8)
            // optional: ignore Flash where possible, use 100% HTML5 mode
            preferFlash: false,
            debugMode: true,
            onready: function() {
                myViewModel.player_ready(true);
            }
        });

        function playSound(song_id) {
            stopSound();
            myViewModel.current_song(song_id);
            for (var i=0; i<playlist.length; i++) {
                if (playlist[i].id == song_id) {
                    var next_id = i==playlist.length-1 ? playlist[0].id : playlist[i+1].id;
                    soundManager.createSound({
                        id: song_id,
                        url: playlist[i].url,
                        autoLoad: true,
                        autoPlay: true,
                        onfinish: function() {
                            playSound(next_id);
                        }
                    });
                }
            }
        }

        function stopSound() {
            var song = soundManager.getSoundById(myViewModel.current_song());
            if (song) {
                myViewModel.current_song(0);
                song.stop();
                song.destruct();
            }
        }
    </script>
{% endblock %}